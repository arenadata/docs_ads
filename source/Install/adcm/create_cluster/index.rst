Создание кластера ADS
=====================

После выполнения `предварительных действий <>`_ и `загрузки бандла <>`_ в кластер-менеджере **ADCM** содержится следующий список объектов (:numref:`Рис.%s.<img_4>`):

* Прототип кластера мониторинга и созданный на его основе экземпляр (программа мониторинга развернута на хосте, ADCM содержит записи о его результатах и настройках);

* Прототип кластера *adb* для создания экземпляров;

* Предварительно сгенерированные четыре хоста на основе бандла *Datafort*. Подразумевается, что хосты физически существуют в облаке *Datafort*, а в базе данных ADCM хранятся записи о них и их учетных данных -- ssh-ключах или паролях.

.. _img_4:

.. figure:: ../../imgs/adcm.*
   :align: center

   Список объектов в ADCM

Данным объектам доступен следующий функционал:

+ `Создание экземпляра кластера`_;
+ `Конфигурация кластера`_;
+ `Добавление сервисов`_;
+ `Добавление хостов`_;
+ `Размещение компонентов сервисов на хостах`_;
+ `Установка сервиса Zookeeper`_;
+ `Установка сервиса Kafka`_;
+ `Установка сервиса Nifi`_;
+ `Установка сервиса Monitoring Clients`_.



Создание экземпляра кластера
----------------------------

При создании кластера в веб-интерфейсе **ADCM** генерируется новый экземпляр кластера *ads*, что означает только добавление данных о нем в базу данных **ADCM** -- на этом этапе не производится установка *ads* на хосты.

1. Открыть в ADCM вкладку "CLUSTERS" (:numref:`Рис.%s.<img_5>`).

.. _img_5:

.. figure:: ../../imgs/adcm.*
   :align: center

   Вкладка "CLUSTERS"


2. Нажать "Add cluster" и в открывшейся форме создать экземпляр кластера из прототипа *ads*, полученного из бандла (:numref:`Рис.%s.<img_6>`).

.. _img_6:

.. figure:: ../../imgs/adcm.*
   :align: center

   Создание экземпляра кластера


3. В результате выполненных действий факт создания экземпляра кластера отображается в базе данных ADCM на вкладке "CLUSTERS" (:numref:`Рис.%s.<img_7>`).


.. _img_7:

.. figure:: ../../imgs/adcm.*
   :align: center

   Результат успешного создания экземпляра кластера



Конфигурация кластера
---------------------

Для перехода к настройкам экземпляра кластера *ads* необходимо нажать кнопку с пиктограммой шестеренки в соответствующей строке вкладки "CLUSTERS" (:numref:`Рис.%s.<img_7>`) и перейти в раздел меню "Configuration". При этом открывается окно конфигурации выбранного экземпляра (:numref:`Рис.%s.<img_8>`).

.. _img_8:

.. figure:: ../../imgs/adcm.*
   :align: center

   Окно конфигурации кластера


В блоке "ADCM" есть возможность настройки адресов:

* *Host* (можно указать fqdn и IP-адрес);
* *Port*.

В блоке настроек "Repositoryes" указываются требуемые для установки *ads* пакеты из различных yum-репозиториев, при этом в каждом из параметров можно изменить заданный по умолчанию url на необходимый:

* ads;
* monitoring;
* epel.

Каждый компонент сервиса кластера имеет возможность отсылать статусную информацию о своем состоянии (keep alive) процессу **ADCM** в докер-контейнере. В ряде случаев **ADCM** может оказаться за NAT, и в таком случае исключается очевидный вариант автоматического определения его адреса, видимого со стороны сервисной компоненты на хосте кластера. Поэтому данный адрес указывается вручную. Во время установки **ADB** адрес **ADCM** используется для заполнения конфигурации компонентов, отвечающих за передачу статусной информации.



Добавление сервисов
-------------------

Кластер **ADS** содержит следующие сервисы:

* *Zookeeper* -- сервис, предназначенный для хранения конфигураций, выполнения распределённой синхронизации процессов;
* *Kafka* -- распределенная пплатформа для потоковых операций и данных;
* *Nifi* -- распрделенная платформа, предназначенная для построения и автоматизации потоков данных между различными системами.
* *Monitoring Clients* -- агенты, отсылающие информацию о хосте и ADS в мониторинг.

Не все сервисы являются обязательными для установки. Например, если вы не планируете использовать **Nifi**, то нет необходимости добавлять этот сервис. Или в случае, когда применяется сервис мониторинга (не на базе **Graphite**), незачем ставить агенты из *Monitoring Clients*. Однако, если планируется использование **Kafka**, одноименный сервис и **Zookeeper** обязательны, тоже самое можно сказать и про сервис **Nifi**. В тоже время сервис может состоять из обязательных и необязательных компонентов. Например, сервис *Kafka* состоит из обязательного компонента *broker* и необязательных: *manager* и *schema-registry*.

В настоящем примере в кластер добавлены все сервисы:

+ `Настройка сервиса Zookeeper`_;
+ `Настройка сервиса Kafka`_;
+ `Настройка сервиса Nifi`_;
+ `Настройка сервиса Monitoring Clients`_.


.. important:: На текущий момент невозможно удалить из кластера уже добавленный сервис


Настройка сервиса Zookeeper
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Для перехода к настройкам сервиса *Zookeeper* необходимо нажать кнопку с пиктограммой шестеренки в соответствующей строке вкладки "SERVICES" и перейти в раздел меню "Configuration". При этом открывается окно конфигурации сервиса *Zookeeper* (:numref:`Рис.%s.<img_13>`).

.. _img_13:

.. figure:: ../../imgs/adcm.*
   :align: center

   Окно конфигурации сервиса Zookeeper


В блоке настроек "Main" задаются основные параметры:

* *connect* -- строка подключения к Znode, в которой Zookeeper хранит конфигурацию текущего кластера, используется сервисом **Kafka**. В текущей реализации данный параметр недоступен для редактирования и генеруруется на стороне ADCM автоматически;

* *data_dirs* -- каталог для хранения транзакционных логов Zookeeper. Данный параметр указывается как *dataDir* в конфигурационном файле *zoo.cfg*; 

* *client_port* -- порт, на котором Zookeeper слушает клиентские подключения.

В блоке настроек "Advanced" задаются следующие расширенные параметры:

* *zoo_cfg_content* -- содержимое файла *zoo.cfg*, которое в дальнейшем шаблонизируется. Данный параметр может использоваться для внесения `дополнительных настроек <https://zookeeper.apache.org/doc/r3.4.12/zookeeperAdmin.html#sc_configuration>`_;

* *zookeeper_env_content* -- содержимое файла *zookeeper-env.sh*, которое в дальнейшем шаблонизируется. Данный параметр может использоваться для внесения переменных окружения; 


Настройка сервиса Kafka
^^^^^^^^^^^^^^^^^^^^^^^^^

Для перехода к настройкам сервиса *kafka* необходимо нажать кнопку с пиктограммой шестеренки в соответствующей строке вкладки "SERVICES" и перейти в раздел меню "Configuration". При этом открывается окно конфигурации сервиса *Kafka* (:numref:`Рис.%s.<img_14>`).

.. _img_14:

.. figure:: ../../imgs/adcm.*
   :align: center

   Окно конфигурации сервиса Kafka


В блоке настроек "Main" задаются основные параметры:

* *data_dirs* -- каталог для хранения данных в *Kafka*. Указывается к качестве параметра *log.dirs* в конфигурационном файле `server.properties  <../../../Config/index>`;

* *listeners* -- список URI (протокол, хост и порт, на котором поднят брокер), разделенный запятыми. Если используется не *PLAINTEXT*  протокол, то необходимо также указать listener.security.protocol.map. Укажите имя хоста как 0.0.0.0 для привязки ко всем интерфейсам. Оставьте имя хоста пустым для привязки к интерфейсу по умолчанию. Указывается к качестве параметра *listeners* в конфигурационном файле `server.properties  <../../../Config/index>`; 

* *default_replication_factor* -- фактор репликации, с которым по умолчанию создаются и хранятся топики. Указывается в качестве параметра *default.replication.factor* в конфигурационном файле `server.properties  <../../../Config/index>`;

* *delete_topic_enable* -- данный параметр позваляет удалять топики. Если данный параметр выключен, то невозможно удалить то  с которым по умолчанию создаются и хранятся топики. Указывается к качестве параметра *default.replication.factor* в конфигурационном файле `server.properties  <../../../Config/index>`;

* *log_retention_hours* -- количество часов, в течение которых топики храняться в *Kafka*. Указывается в качестве параметра *log.retention.hours* в конфигурационном файле `server.properties  <../../../Config/index>`;

* *log_roll_hours* -- максимальное время, после которого пояляется новый журнал сегмента, даже если старый журнал не переполненю Указывается к качестве параметра *log.roll.hours* в конфигурационном файле `server.properties  <../../../Config/index>`;

* *broker_jmx_port* -- порт, по которому *Kafka* брокер отдает *jmx* метрики. Указывается в качестве параметра *JMX_PORT* в файле *kafka-env.sh*;

* *manager_port* -- порт, на котором поднимается *Kafka-Manager*. Указывается в файле *kafka-manager-env.sh*;

* *schema_registry_heap_opts* -- размер кучи, выделяемый процессу сервиса *schema-registry*. Указывается в качестве параметра *SCHEMA_REGISTRY_HEAP_OPTS* в *schema-registry-env.sh*;

* *schema_registry_listener_port* -- порт, который слушает *schema-registry*. Указывается в качестве параметра *listeners* в конфигурационном файле *schema-registry.properties*;

В блоке настроек "Advanced" задаются следующие расширенные параметры:

* *server_properties_content* -- содержимое файла *server.properties*, которое в дальнейшем шаблонизируется. Данный параметр может использоваться для внесения `дополнительных настроек <../../../Config/index>`_;

* *kafka_env_content* -- содержимое файла *kafka-env.sh*, которое в дальнейшем шаблонизируется. Данный параметр может использоваться для внесения переменных окружения.

  
Настройка сервиса monitoring clients
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

.. important:: На текущий момент у сервиса monitoring clients отсутствуют параметры для настройки



Добавление хостов
-----------------

По результатам `предварительных действий <>`_ в **ADCM** создано четыре хоста в облаке *Datafort* (их адреса и учетные данные сохранены в их конфигурациях). На данном этапе их следует добавить в кластер *adb*:

1. В меню кластера *adb* открыть вкладку "Hosts" (:numref:`Рис.%s.<img_15>`).

.. _img_15:

.. figure:: ../../../imgs/adcm.*
   :align: center

   Вкладка "Hosts" кластера adb

2. Нажать "Add hosts" и в открывшейся форме выбрать необходимые хосты (:numref:`Рис.%s.<img_16>`).

.. _img_16:

.. figure:: ../../../imgs/adcm.*
   :align: center

   Выбор хостов


3. В результате выполненных действий факт добавления хостов отображается в кластере *adb* в списке вкладки "Hosts" (:numref:`Рис.%s.<img_17>`).


.. _img_17:

.. figure:: ../../../imgs/adcm.*
   :align: center

   Результат успешного добавления хостов



Размещение компонентов сервисов на хостах
-----------------------------------------

Каждый сервис состоит из компонентов, которые должны быть размещены на хостах в кластере. Для этого необходимо на вкладке кластера "Hosts - Components" выбрать компонент посредством нажатия на него мышкой в колонке "Components" и определить для него необходимый хост в колонке "Hosts" (:numref:`Рис.%s.<img_18>`).


.. _img_18:

.. figure:: ../../../imgs/adcm.*
   :align: center

   Размещение компонентов сервисов на хостах


Поскольку службы *adb*, *chrony* и *monitoring clients* добавлены в кластер **ADB**, но еще не размещены на хостах, то изначально ни на одном из хостов нет компонентов:

1. Компоненты сервиса *adb* (:numref:`Рис.%s.<img_19>`):

* *adb.master* -- необходимо добавить строго на один хост мастера (*df-mdw*);

* *adb.segment* -- необходимо добавить на один или более хостов сегментов (*df-sdw2*, *df-sdw2*);

* *adb.standby* -- опционально может быть добавлен на один хост резервного мастера (*df-smdw*).

.. _img_19:

.. figure:: ../../../imgs/adcm.*
   :align: center

   Компоненты сервиса adb


2. Компоненты сервиса *chrony* (:numref:`Рис.%s.<img_20>`):

* *chrony.master* -- необходимо добавить строго на один хост мастера (*df-mdw*);

* *chrony.segment* -- опционально может быть добавлен на любое количество хостов сегментов (*df-sdw2*, *df-sdw2*);

* *chrony.standby* -- опционально может быть добавлен на любое количество хостов резервного мастера (*df-smdw*).

.. _img_20:

.. figure:: ../../../imgs/adcm.*
   :align: center

   Компоненты сервиса chrony


3. Компоненты сервиса *monitoring clients*:

* *monitoring_clients.agent* -- опционально может быть добавлен на любое количество хостов (*df-mdw*, *df-smdw*, *df-sdw1*, *df-sdw2*). Собирает метрики с хостов (рекомендуется разместить агента мониторинга на всех хостах кластера).


Установка сервиса adb
---------------------

Для установки сервиса *adb* необходимо выполнить ряд действий на вкладке кластера "Services":

1. Install ADB -- производится настройка хостов, установка необходимых пакетов и перезагрузка хостов для применения конфигурации *sysctl*:

* В поле "Actions" нажать на пиктограмму в строке сервиса *adb* и выбрать действие *Install_ADB* (:numref:`Рис.%s.<img_23>`).

.. _img_23:

.. figure:: ../../../imgs/adcm.*
   :align: center

   Install_ADB


* Установить булевый флаг для перезагрузки хостов после окончания установки (:numref:`Рис.%s.<img_24>`). В ином случае перезагрузку необходимо произвести вручную.

.. _img_24:

.. figure:: ../../../imgs/adcm.*
   :align: center

   Action parameters


* По результатам инсталляции сервис *adb* меняет состояние с *created* -- создан, на *installed* -- установлен (:numref:`Рис.%s.<img_25>`).

.. _img_25:

.. figure:: ../../../imgs/adcm.*
   :align: center

   Статус сервиса


2. Initdb -- создание кластера ADB на подготовленных хостах:

* В поле "Actions" нажать на пиктограмму в строке сервиса *adb* и выбрать действие *Initdb* (:numref:`Рис.%s.<img_26>`).

.. _img_26:

.. figure:: ../../../imgs/adcm.*
   :align: center

   Initdb


* Подтвердить действие в открывшемся диалоговом окне (:numref:`Рис.%s.<img_27>`).

.. _img_27:

.. figure:: ../../../imgs/adcm.*
   :align: center

   Запрос на подтверждение действия


* По результатам создания кластера сервис *adb* меняет состояние с *installed* -- установлен, на *initialized* -- инициализирован. На данном этапе становится доступна кнопка "Check" для проверки работоспособности кластера (:numref:`Рис.%s.<img_28>`).

.. _img_28:

.. figure:: ../../../imgs/adcm.*
   :align: center

   Кластер инициализирован, доступна кнопка "Check"


3. Create database -- создание базы данных с именем, указанным в параметре *Name of defult database* в настройках сервиса *adb*, и установка скриптов в *crontab*:

* В поле "Actions" нажать на пиктограмму в строке сервиса *adb* и выбрать действие *Create_Database* (:numref:`Рис.%s.<img_29>`).

.. _img_29:

.. figure:: ../../../imgs/adcm.*
   :align: center

   Create_Database
 
* Подтвердить действие в открывшемся диалоговом окне (:numref:`Рис.%s.<img_30>`).

.. _img_30:

.. figure:: ../../../imgs/adcm.*
   :align: center

   Запрос на подтверждение действия



Установка сервиса chrony
------------------------

Сервис *chrony* является опциональным и может запускаться многократно с целью изменения его настроек. Для этого необходимо выполнить ряд действий на вкладке кластера "Services":

* В строке сервиса *chrony* в поле "Actions" нажать на пиктограмму и выбрать действие *Install* (:numref:`Рис.%s.<img_31>`).

.. _img_31:

.. figure:: ../../../imgs/adcm.*
   :align: center

   Install chrony


* Подтвердить действие в открывшемся диалоговом окне (:numref:`Рис.%s.<img_32>`).

.. _img_32:

.. figure:: ../../../imgs/adcm.*
   :align: center

   Запрос на подтверждение действия


* По результатам инсталляции сервис *chrony* меняет состояние с *created* -- создан, на *synced* -- синхронизирован (:numref:`Рис.%s.<img_33>`).

.. _img_33:

.. figure:: ../../../imgs/adcm.*
   :align: center

   Статус сервиса



Установка сервиса monitoring clients
------------------------------------

Сервис *monitoring clients* является опциональным и требует импорта конфигурационных параметров кластера мониторинга (адреса, логин/пароль) в кластер *adb*:

1. Для импорта конфигурации мониторинга в кластер *adb* необходимо открыть в ADCM вкладку "CLUSTERS", выбрать опцию *Import* и отметить импортируемые настройки сервисов с помощью простановки флажков в открывшейся форме (:numref:`Рис.%s.<img_35>`).

.. _img_35:

.. figure:: ../../../imgs/adcm.*
   :align: center

   Импорт конфигурации мониторинга


2. Установка клиентов мониторинга в кластер *adb*:

* В кластере *adb* на вкладке "Services" в поле "Actions" нажать на пиктограмму и выбрать действие *Install* для службы *monitoring clients* (:numref:`Рис.%s.<img_36>`).

.. _img_36:

.. figure:: ../../../imgs/adcm.*
   :align: center

   Установка клиентов мониторинга


* Подтвердить действие в открывшемся диалоговом окне (:numref:`Рис.%s.<img_37>`).

.. _img_37:

.. figure:: ../../../imgs/adcm.*
   :align: center

   Запрос на подтверждение действия


* По результатам инсталляции служба *monitoring clients* меняет состояние с *created* -- создана, на *monitored* -- мониторится (:numref:`Рис.%s.<img_38>`).

.. _img_38:

.. figure:: ../../../imgs/adcm.*
   :align: center

   Статус службы

